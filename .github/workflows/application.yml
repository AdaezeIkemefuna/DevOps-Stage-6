name: Application Deployment

on:
  push:
    paths:
      - 'frontend/**'
      - 'auth-api/**'
      - 'todos-api/**'
      - 'users-api/**'
      - 'log-message-processor/**'
      - 'docker-compose.yml'
      - '.env'
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug Network Connectivity
        run: |
          echo "üîç Network Diagnostics:"
          echo "GitHub Runner IP: $(curl -s ifconfig.me)"
          echo "Target Server: ${{ secrets.SERVER_IP }}"
          
          # Test basic connectivity
          echo "Testing port 22..."
          timeout 5 bash -c "echo > /dev/tcp/${{ secrets.SERVER_IP }}/22" && echo "‚úÖ Port 22 is open" || echo "‚ùå Port 22 is closed"
          
          # Test SSH key format
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > test_key.pem
          chmod 600 test_key.pem
          ssh-keygen -l -f test_key.pem && echo "‚úÖ SSH key valid" || echo "‚ùå SSH key invalid"

      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          timeout: 30s
          script: |
            echo "‚úÖ Connected successfully!"
            cd /opt/todo-app
            git pull origin main
            docker compose down
            docker compose up -d --build
            docker compose ps